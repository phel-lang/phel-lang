(ns phel-test\test\core
  (:require phel\test :refer [deftest is]))

# -------------
# Destructuring
# -------------

(deftest destructure-vector
  (is (= 3 (let [[a b] [1 2]] (+ a b))) "from vector")
  (is (= 3 (let [[a b] (php/array 1 2)] (+ a b))) "from php array")
  (is (= 10 (let [[a [c d] b] [1 (list 4 3) 2]] (+ a b c d))) "nested")
  (is (= 4 (let [[a _ b] [1 2 3]] (+ a b))) "ignore value"))

(deftest destructure-hash-map
  (is (= 3 (let [{:a a :b b} {:a 1 :b 2}] (+ a b))) "destructure hash map")
  (is (= 6 (let [{:a [a1 a2] :b b} {:a [1 3] :b 2}] (+ a1 a2 b))) "nested destructure hash map"))

# ----------------------------
# Basic methods for quasiquote
# ----------------------------

(deftest test-next
  (is (nil? (next [])) "next of empty vector")
  (is (nil? (next [1])) "next of one element vector")
  (is (= [2] (next [1 2])) "next of two element vector"))

(deftest test-concat
  (is (= [1 2] (concat [1 2])) "concat one argument")
  (is (= [1 2 3 4] (concat [1 2] [3 4])) "concat two arguments")
  (is (= [1 2 3 4] (concat [1] [2 3] [4])) "concat three arguments")
  (is (= '() (concat nil)) "concat nil")
  (is (= '() (concat nil nil)) "concat two nil")
  (is (= [1 2 3 4 5 6] (concat [1 2 3] nil [4 5 6])) "concat vectors and nil"))

(deftest test-set-push
  (let [s1 (set 1 2)
        s2 (push s1 3)]
    (is (= (set 1 2 3) s2) "set push"))
  (let [s1 (set 1 2)
        s2 (push s1 2)]
    (is (= (set 1 2) s2) "set push existing value")))

(deftest test-set-concat
  (is (= (set 0 1 2 3) (concat (set 1 2) [0 3])) "set concat vector")
  (is (= (set 0 1 2 3) (concat (set 1 2) [0 1 2 3])) "set concat vector with common values")
  (is (= (set 0 1 2) (concat (set 1 2) (set 0 1))) "set concat"))

(defstruct my-struct [a b c])

(deftest test-struct
  (let [x (my-struct 1 2 3)]
    (is (= :struct (type x)) "struct: common type")
    (is (true? (struct? x)) "struct: common type test")
    (is (= 1 (get x :a)) "struct: get value from struct")
    (is (= (my-struct 12 2 3) (put x :a 12)) "struct: put value on struct")
    (is (true? (my-struct? x)) "struct: correct type")
    (is (false? (my-struct? :a)) "struct: incorrect type")))

(deftest test-__FILE__
  (is (true? (>= (php/strpos __FILE__ "tests/phel/test/core.phel") 0)) "__FILE__"))

(deftest test-__DIR__
  (is (true? (and (false? (php/strpos __DIR__ "tests/phel/test/core.phel")) (>= (php/strpos __DIR__ "tests/phel/test") 0))) "__DIR__"))


(deftest test-var
  (is (= :var (type (var 10))) "type of var is :var")
  (is (= 10 (deref (var 10))) "deref variable")
  (is (true? (var? (var 10))) "var? return true if x is a variable")
  (is (false? (var? 10)) "var? return false if x is a number")
  (is (= 20 (let [x (var 10)] (set! x 20) (deref x))) "set new value to variable")
  (is (= 11 (let [x (var 10)] (swap! x + 1) (deref x))) "swap a value by incrementing the number"))
