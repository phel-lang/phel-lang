(ns phel-test\test\core\file-operation
  (:require phel\test :refer [deftest is thrown?]))

(deftest test-slurp
  (is (string? (slurp php/__FILE__)) "reads current file successfully")
  (is (thrown? \InvalidArgumentException
               (slurp (php/dirname php/__DIR__))) "reading a directory throws exception"))

(deftest test-spit
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-spit.txt")]
    (is (= 6 (spit target-file "FOOBAR"))
        "successful writing returning number of bytes written")
    (is (= "FOOBAR" (slurp target-file)) "written file reads back correctly")
    (is (= 3 (spit target-file "BAZ" {:flags php/FILE_APPEND}))
        "successful writing with append, returning number of bytes written")
    (is (= "FOOBARBAZ" (slurp target-file)) "written file reads back correctly after appending")
    (is (= 4 (spit target-file "TEST"))
        "successful writing returning number of bytes written")
    (is (= "TEST" (slurp target-file)) "written file reads back correctly after over writing")
    (is (thrown? \InvalidArgumentException (spit target-directory "test"))
        "writing to a directory path throws exception")
    (php/unlink target-file)))

(deftest test-line-seq-basic
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq.txt")]
    (spit target-file "line1\nline2\nline3")
    (is (= ["line1" "line2" "line3"] (doall (line-seq target-file)))
        "line-seq reads all lines correctly")
    (php/unlink target-file)))

(deftest test-line-seq-empty-file
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq-empty.txt")]
    (spit target-file "")
    (is (= [] (doall (line-seq target-file)))
        "line-seq returns empty sequence for empty file")
    (php/unlink target-file)))

(deftest test-line-seq-single-line
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq-single.txt")]
    (spit target-file "single line")
    (is (= ["single line"] (doall (line-seq target-file)))
        "line-seq reads single line correctly")
    (php/unlink target-file)))

(deftest test-line-seq-with-crlf
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq-crlf.txt")]
    (spit target-file "line1\r\nline2\r\nline3")
    (is (= ["line1" "line2" "line3"] (doall (line-seq target-file)))
        "line-seq handles CRLF line endings correctly")
    (php/unlink target-file)))

(deftest test-line-seq-is-lazy
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq-lazy.txt")]
    (spit target-file "line1\nline2\nline3\nline4\nline5\nline6\nline7\nline8\nline9\nline10")
    (is (= ["line1" "line2" "line3"] (take 3 (line-seq target-file)))
        "line-seq is lazy and works with take")
    (php/unlink target-file)))

(deftest test-line-seq-trailing-newline
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq-trailing.txt")]
    (spit target-file "line1\nline2\n")
    (is (= ["line1" "line2"] (doall (line-seq target-file)))
        "line-seq handles trailing newline correctly")
    (php/unlink target-file)))

(deftest test-line-seq-non-existent-file
  (is (thrown? \InvalidArgumentException (doall (line-seq "/non/existent/file.txt")))
      "line-seq throws exception for non-existent file"))

(deftest test-line-seq-directory
  (is (thrown? \InvalidArgumentException (doall (line-seq (php/sys_get_temp_dir))))
      "line-seq throws exception for directory"))

(deftest test-line-seq-returns-lazy-seq
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-line-seq-type.txt")]
    (spit target-file "line1\nline2")
    (let [result (line-seq target-file)]
      (is (true? (php/instanceof result \Phel\Lang\Collections\LazySeq\LazySeqInterface))
          "line-seq should return a lazy sequence"))
    (php/unlink target-file)))

(deftest test-file-seq-with-directory
  (let [target-directory (str (php/sys_get_temp_dir) php/DIRECTORY_SEPARATOR "test-file-seq")
        sub-dir (str target-directory php/DIRECTORY_SEPARATOR "subdir")
        file1 (str target-directory php/DIRECTORY_SEPARATOR "file1.txt")
        file2 (str sub-dir php/DIRECTORY_SEPARATOR "file2.txt")]
    (php/mkdir target-directory)
    (php/mkdir sub-dir)
    (spit file1 "content1")
    (spit file2 "content2")
    (let [result (doall (file-seq target-directory))
          result-count (count result)]
      (is (>= result-count 3) "file-seq should return at least the directory and subdirectory and files")
      (is (true? (some |(php/str_ends_with $ "file1.txt") result))
          "file-seq should include file1.txt")
      (is (true? (some |(php/str_ends_with $ "file2.txt") result))
          "file-seq should include file2.txt"))
    (php/unlink file2)
    (php/unlink file1)
    (php/rmdir sub-dir)
    (php/rmdir target-directory)))

(deftest test-file-seq-with-file
  (let [target-directory (str (php/sys_get_temp_dir))
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test-file-seq-single.txt")]
    (spit target-file "content")
    (let [result (doall (file-seq target-file))]
      (is (= 1 (count result)) "file-seq with file should return single item")
      (is (= target-file (first result)) "file-seq with file should return the file path"))
    (php/unlink target-file)))

(deftest test-file-seq-is-lazy
  (let [target-directory (str (php/sys_get_temp_dir) php/DIRECTORY_SEPARATOR "test-file-seq-lazy")
        file1 (str target-directory php/DIRECTORY_SEPARATOR "file1.txt")
        file2 (str target-directory php/DIRECTORY_SEPARATOR "file2.txt")
        file3 (str target-directory php/DIRECTORY_SEPARATOR "file3.txt")]
    (php/mkdir target-directory)
    (spit file1 "content1")
    (spit file2 "content2")
    (spit file3 "content3")
    (let [result (take 2 (file-seq target-directory))]
      (is (= 2 (count result)) "file-seq should be lazy and work with take"))
    (php/unlink file3)
    (php/unlink file2)
    (php/unlink file1)
    (php/rmdir target-directory)))

(deftest test-file-seq-non-existent-path
  (is (thrown? \InvalidArgumentException (doall (file-seq "/non/existent/path")))
      "file-seq throws exception for non-existent path"))

(deftest test-file-seq-returns-lazy-seq
  (let [target-directory (str (php/sys_get_temp_dir) php/DIRECTORY_SEPARATOR "test-file-seq-type")
        target-file (str target-directory php/DIRECTORY_SEPARATOR "test.txt")]
    (php/mkdir target-directory)
    (spit target-file "content")
    (let [result (file-seq target-directory)]
      (is (true? (php/instanceof result \Phel\Lang\Collections\LazySeq\LazySeqInterface))
          "file-seq should return a lazy sequence"))
    (php/unlink target-file)
    (php/rmdir target-directory)))

(deftest test-file-seq-filter-by-extension
  (let [target-directory (str (php/sys_get_temp_dir) php/DIRECTORY_SEPARATOR "test-file-seq-filter")
        file1 (str target-directory php/DIRECTORY_SEPARATOR "test.phel")
        file2 (str target-directory php/DIRECTORY_SEPARATOR "test.txt")
        file3 (str target-directory php/DIRECTORY_SEPARATOR "test.md")]
    (php/mkdir target-directory)
    (spit file1 "phel content")
    (spit file2 "txt content")
    (spit file3 "md content")
    (let [phel-files (filter |(php/str_ends_with $ ".phel") (file-seq target-directory))]
      (is (= 1 (count (doall phel-files))) "should filter to only .phel files"))
    (php/unlink file3)
    (php/unlink file2)
    (php/unlink file1)
    (php/rmdir target-directory)))
