#!/usr/bin/expect -f

# Set timeout and configure error handling
set timeout 1

# Start the REPL
spawn ./bin/phel repl

# Wait for the welcome message and initial prompt
expect {
    "Welcome to the Phel Repl" { }
    timeout { 
        puts "ERROR: Welcome message not found"
        exit 1 
    }
}

expect {
    "phel:1> " { }
    timeout { 
        puts "ERROR: Initial prompt not found"
        exit 1 
    }
}

# Send the command
send "(require phel\\html :as html) html/html\r"

# First, expect the echoed input (and ignore it)
expect {
    -re "\\(require.*html/html" { }
    timeout { 
        puts "ERROR: Command echo not found"
        exit 1 
    }
}

# Now expect the actual output
expect {
    "<function>" { 
        puts "SUCCESS: Found expected <function> output"
    }
    timeout { 
        puts "ERROR: Expected <function> but got timeout"
        exit 1 
    }
    eof { 
        puts "ERROR: REPL exited unexpectedly"
        exit 1 
    }
    -re "(\[^\r\n\]+)" {
        puts "ERROR: Expected <function> but got: $expect_out(1,string)"
        exit 1
    }
}

# Check for next prompt
expect {
    "phel:2> " { 
        puts "SUCCESS: Found expected next prompt"
    }
    timeout { 
        puts "ERROR: Expected phel:2> prompt not found"
        exit 1 
    }
}

# Exit cleanly
send "exit\r"
expect eof

puts "All tests passed!"
exit 0
